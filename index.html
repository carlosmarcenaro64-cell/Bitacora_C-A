<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bit√°cora de C/A | Archivo de Aventuras</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<header class="main-header fade-in">
    <h1 class="glow-title">BIT√ÅCORA DE C/A</h1>
    <p class="subtitle">Archivo de Aventuras Eternas</p>
</header>

<main class="container">
    <section class="glass-panel filters fade-in-up">
        <div class="filter-row">
            <div class="filter-item">
                <label>üìÖ Por Fecha</label>
                <input type="date" id="filtroFecha" onchange="window.filtrar()">
            </div>
            <div class="filter-item">
                <label>‚≠ê Por Estrellas</label>
                <select id="filtroEstrellas" onchange="window.filtrar()">
                    <option value="todos">Todos</option>
                    <option value="10">10 Estrellas</option>
                    <option value="9">9 Estrellas</option>
                    <option value="8">8 Estrellas</option>
                    <option value="7">7 o menos</option>
                </select>
            </div>
            <button class="btn-clean" onclick="location.reload()">Limpiar Filtros</button>
        </div>
    </section>

    <section class="glass-panel form-card fade-in-up">
        <div class="form-header">
            <h3>üìù Registrar Nueva Experiencia</h3>
            <span id="editBadge" class="badge-edit hidden">MODO EDICI√ìN</span>
        </div>
        
        <input type="hidden" id="editKey">
        
        <div class="form-body">
            <div class="input-row main-select">
                <select id="tipoEntrada" onchange="window.alternarCampos()">
                    <option value="lugar">üìç Salida / Lugar</option>
                    <option value="cine">üé¨ Pel√≠cula / Cine</option>
                </select>
            </div>

            <div class="input-grid">
                <div class="input-group">
                    <input type="text" id="nombre" placeholder=" " required>
                    <label>Nombre del lugar o pel√≠cula</label>
                </div>
                <div class="input-group">
                    <input type="text" id="foto" placeholder=" " required>
                    <label>URL de la imagen</label>
                </div>
                <div class="input-group">
                    <input type="date" id="fecha" required>
                    <label class="static-label">Fecha</label>
                </div>
            </div>

            <div id="camposLugar" class="dynamic-section">
                <div class="input-grid-2">
                    <div class="input-group">
                        <input type="number" id="califLugar" min="1" max="10" placeholder=" ">
                        <label>Puntuaci√≥n (1-10)</label>
                    </div>
                    <div class="input-group">
                        <input type="text" id="datoLugar" placeholder=" ">
                        <label>Dato importante</label>
                    </div>
                </div>
                <div class="textarea-grid">
                    <textarea id="divertido" placeholder="Lo m√°s divertido..."></textarea>
                    <textarea id="aburrido" placeholder="Lo m√°s aburrido..."></textarea>
                </div>
            </div>

            <div id="camposCine" class="dynamic-section hidden">
                <div class="input-grid-2">
                    <div class="input-group">
                        <input type="number" id="estrellas" min="1" max="10" placeholder=" ">
                        <label>Estrellas (1-10)</label>
                    </div>
                    <div class="input-group">
                        <input type="text" id="sensaciones" placeholder=" ">
                        <label>Sensaciones</label>
                    </div>
                </div>
                <div class="textarea-grid">
                    <textarea id="gustoCine" placeholder="Lo que m√°s nos gust√≥..."></textarea>
                    <textarea id="noGustoCine" placeholder="Lo que no nos gust√≥..."></textarea>
                </div>
            </div>

            <div class="form-footer">
                <button class="btn-save" id="btnGuardar">Guardar en la Nube</button>
                <button class="btn-cancel hidden" id="btnCancelar" onclick="window.cancelarEdicion()">Cancelar</button>
            </div>
        </div>
    </section>

    <div class="grid-display" id="contenedorPrincipal"></div>
</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDgc_fOFDZZTcBe2mtD0uGpgcFl4f34oPI",
        authDomain: "bitacora-ca.firebaseapp.com",
        projectId: "bitacora-ca",
        storageBucket: "bitacora-ca.firebasestorage.app",
        messagingSenderId: "707668977849",
        appId: "1:707668977849:web:5e72c6eb55fcdfb4dad368",
        databaseURL: "https://bitacora-ca-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const aventurasRef = ref(db, 'aventuras');

    window.alternarCampos = () => {
        const t = document.getElementById('tipoEntrada').value;
        document.getElementById('camposLugar').classList.toggle('hidden', t !== 'lugar');
        document.getElementById('camposCine').classList.toggle('hidden', t !== 'cine');
    };

    document.getElementById('btnGuardar').onclick = () => {
        const key = document.getElementById('editKey').value;
        const tipo = document.getElementById('tipoEntrada').value;
        const entry = {
            tipo,
            nombre: document.getElementById('nombre').value,
            foto: document.getElementById('foto').value,
            fecha: document.getElementById('fecha').value,
            rating: tipo === 'lugar' ? document.getElementById('califLugar').value : document.getElementById('estrellas').value,
            divertido: document.getElementById('divertido').value || "",
            aburrido: document.getElementById('aburrido').value || "",
            sensaciones: document.getElementById('sensaciones').value || "",
            gusto: document.getElementById('gustoCine').value || "",
            noGusto: document.getElementById('noGustoCine').value || "",
            dato: document.getElementById('datoLugar').value || ""
        };

        if(key) {
            update(ref(db, `aventuras/${key}`), entry).then(() => location.reload());
        } else {
            push(aventurasRef, entry).then(() => location.reload());
        }
    };

    onValue(aventurasRef, (snap) => {
        window.raw = snap.val();
        window.render(window.raw);
    });

    window.render = (data) => {
        const cont = document.getElementById('contenedorPrincipal');
        cont.innerHTML = '';
        if(!data) return;
        Object.keys(data).reverse().forEach(id => {
            const e = data[id];
            cont.innerHTML += `
                <div class="card fade-in">
                    <img src="${e.foto}" class="card-img">
                    <div class="card-info">
                        <span class="tag ${e.tipo}">${e.tipo}</span>
                        <h3>${e.nombre}</h3>
                        <p class="card-date">üìÖ ${e.fecha}</p>
                        <p class="card-rating">‚≠ê ${e.rating}/10</p>
                        <div class="card-actions">
                            <button class="edit-btn" onclick="prepararEdicion('${id}')">Editar</button>
                            <button class="del-btn" onclick="borrar('${id}')">Borrar</button>
                        </div>
                    </div>
                </div>`;
        });
    };

    window.prepararEdicion = (id) => {
        const e = window.raw[id];
        document.getElementById('editKey').value = id;
        document.getElementById('tipoEntrada').value = e.tipo;
        document.getElementById('nombre').value = e.nombre;
        document.getElementById('foto').value = e.foto;
        document.getElementById('fecha').value = e.fecha;
        if(e.tipo === 'lugar') {
            document.getElementById('califLugar').value = e.rating;
            document.getElementById('divertido').value = e.divertido;
            document.getElementById('aburrido').value = e.aburrido;
            document.getElementById('datoLugar').value = e.dato;
        } else {
            document.getElementById('estrellas').value = e.rating;
            document.getElementById('sensaciones').value = e.sensaciones;
            document.getElementById('gustoCine').value = e.gusto;
            document.getElementById('noGustoCine').value = e.noGusto;
        }
        window.alternarCampos();
        document.getElementById('formTitle').innerText = "‚úèÔ∏è Editando Aventura";
        document.getElementById('btnGuardar').innerText = "Actualizar Registro";
        document.getElementById('btnCancelar').classList.remove('hidden');
        document.getElementById('editBadge').classList.remove('hidden');
        window.scrollTo({top: 0, behavior: 'smooth'});
    };

    window.borrar = (id) => confirm("¬øDesea borrar este recuerdo?") && remove(ref(db, `aventuras/${id}`));
    window.cancelarEdicion = () => location.reload();
</script>
</body>
</html>
